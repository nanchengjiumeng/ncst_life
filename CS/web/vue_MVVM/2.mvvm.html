<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>vue_双向绑定</title>
</head>
<body>
<div id="app">
    <input type="text" w-model="msg">
    <input type="text" w-model="name">
    {{msg}}
    {{name}}
    <div>************</div>
    <div>{{name}}</div>
</div>
</body>
</html>
<script>
    // 将数据和对应的data文本节点 bind到一起、
    function ViewModel(data) {
        this.data = data;
        this.nodes = []; //放置对应的节点
    }
    ViewModel.prototype.bindNode = function (node) {
        this.nodes.push(node);
    };
    ViewModel.prototype.getValue=function () {
        return this.data;
    };
    ViewModel.prototype.update = function () { //依次渲染成想要的结果
        this.nodes.forEach(node=>{
            if(node.nodeType===1){
                node.value = this.data;
            }else {
                node.textContent = node.w_model.replace(/\{\{([^}]*)\}\}/g,function () {
                    return obj[arguments[1]].data;
                })
            }
        })
    };
    ViewModel.prototype.setValue=function (newVal) {
        if(newVal !== this.data){ //如果设置的值和老值相同
            this.data = newVal;
            this.update();
        }
    };



    let obj ={
        msg:new ViewModel('welcome!'),
        name:new ViewModel('wang!')
    };

    function compile(el_id) {
        let el = document.querySelector(el_id);
        // 不要直接操作节点，可能会导致页面回流.


        let fragment = document.createDocumentFragment();
        //取ele下的第一个元素，直到去完为止，并且放到fragment里面
        let child;
        while (child=el.firstChild){
            fragment.appendChild(child);
        }
        //将fragment转为数组

        function replace(NODE) {
            Array.from(NODE.childNodes).forEach(node=>{
                if(node.nodeType === 1){// 1 为元素节点
                    Array.from(node.attributes).forEach(attr=>{
                        let {name,value}=attr;
                        if(name.includes('w-')){
                            obj[value].bindNode(node);
                            node.addEventListener('input',function (e) {
                                obj[value].setValue(e.target.value)
                            })
                        }
                    })
                }
                let reg = /\{\{([^}]*)\}\}/g;
                let text = node.textContent;
                if(node.nodeType === 3 && reg.test(text)){// 3 为文本节点
                    node.w_model = text;
                    // 自定义属性 保留原有的内容
                    text.replace(reg,function () {
                        text.replace(reg,function () {
                            obj[arguments[1]].bindNode(node);
                        })
                    })
                }
                if(node.childNodes.length){
                    replace(node);
                }
            });
        }
        replace(fragment);

        //body在此处操作dom不会导致回流和重绘
        Object.keys(obj).forEach(key=>{
            obj[key].update();
        });


        el.appendChild(fragment);



    }
    compile('#app');

</script>